# Active Directory Account Manager

Проект задумывался как способ автоматизировать создание учетных записей в Active Directory.
Чтобы любой сотрудник мог самостоятельно создать AD аккаунт или сменить для него пароль не беспокоя администратора.

## Задача и требования от заказчика

- Создать страничку, которая будет из себя представлять сервис по созданию учетки в AD
- Желательно, чтобы создание учетки в AD работало без участия человека
- Показывать пользователю определенным образом значения аккаунта, в их числе логин, пароль и некоторые параметры подключения к контроллеру домена
- Обычно каждому пользователю достаточно одного AD аккаунта
- Авторизация должна производиться через корпоративный SSO
- В AD должен быть
  - Создан пользователь
  - Создан organisation unit для этого пользователя
  - Добавить пользователя в уже существующую группу

## Реализация

Договор о наименованиях:
Пользователь (user) - пользоватесь сервиса, который логинится через SSO и хранится в таблице users
Аккаунт (учетная запись) - LDAP пользователь, который и требуется создать, хранится в таблице ldap_accounts

В требованиях подразумевается, что у пользователя может быть только один LDAP аккаунт и только в AD реализации.
В частности, сброс пароля реализован исходя из предпосылки одного аккаунта на пользователя.
Задел для создания нескольких аккаунтов частично был предусмотрен.
Для подключения других реализаций LDAP необходимо расширять функционал сервиса.

### Поведение

- Пользователь логинится через SSO
- Username для AD аккаунта формируется из email, указанного в профиле SSO
- Сервис проверяет в базе наличие записи о существовании AD учетки для этого пользователя
  - Если запись существует, пользователю показываются параметры подключения
  - Если записи не существует, предлагается создать новый аккаунт
- При создании AD аккаунта
  - Если аккаунт с таким username не существует в AD
    - Генерируется пароль
    - Создаётся учётная запись
    - Создаётся пользовательский OU
    - Назначаются права на этот UO путем добавления в группу
  - Если аккаунт с таким username уже существует в AD
    - Генерируется новый пароль
    - Пароль аккаунта принудительно сбрасывается на новый
  - Данные аккаунта (username, пароль в зашифрованном виде) сохраняются в базе данных и связываются с профилем пользователя. Это предотвращает необходимость сброса пароля для его отображения, так как пароль в AD нельзя посмотреть, а только сбросить
- После появления записи об AD аккаунте в БД, результат отображается на страничке в виде списка параметров для настройки ADCM

## Installing packages for building dependencies

```shell
python3 -m venv .venv
source ./.venv/bin/activate
```

### macOS

```shell
pip install python-ldap \
    --global-option=build_ext \
    --global-option="-I$(xcrun --show-sdk-path)/usr/include/sasl"
```

### Alpine

```shell
apk add build-base openldap-dev python2-dev python3-dev
```

### CentOS

```shell
yum groupinstall "Development tools"
yum install openldap-devel python-devel
```

### Debian

```shell
apt-get install build-essential python3-dev python2.7-dev \
    libldap2-dev libsasl2-dev slapd ldap-utils tox \
    lcov valgrind
```

## Installing dependencies

```shell
./.venv/bin/pip install -U pip setuptools
./.venv/bin/pip install poetry
poetry install
```

## Run

```shell
cd adam
uvicorn main:app --host 0.0.0.0 --port 8000 --reload
```
